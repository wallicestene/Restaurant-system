"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const datasource_toolkit_1 = require("@forestadmin/datasource-toolkit");
class RelationCollectionDecorator extends datasource_toolkit_1.CollectionDecorator {
    constructor() {
        super(...arguments);
        this.relations = {};
    }
    addRelation(name, partialJoint) {
        const relation = this.relationWithOptionalFields(partialJoint);
        this.checkForeignKeys(relation);
        this.checkOriginKeys(relation);
        this.relations[name] = relation;
        this.markSchemaAsDirty();
    }
    async list(caller, filter, projection) {
        const newFilter = await this.refineFilter(caller, filter);
        const newProjection = projection.replace(this.rewriteField, this).withPks(this);
        const records = await this.childCollection.list(caller, newFilter, newProjection);
        if (newProjection.equals(projection))
            return records;
        await this.reprojectInPlace(caller, records, projection);
        return projection.apply(records);
    }
    async aggregate(caller, filter, aggregation, limit) {
        const newFilter = await this.refineFilter(caller, filter);
        // No emulated relations are used in the aggregation
        if (Object.keys(aggregation.projection.relations).every(prefix => !this.relations[prefix])) {
            return this.childCollection.aggregate(caller, newFilter, aggregation, limit);
        }
        // Fallback to full emulation.
        return aggregation.apply(await this.list(caller, filter, aggregation.projection), caller.timezone, limit);
    }
    refineSchema(subSchema) {
        const schema = { ...subSchema, fields: { ...subSchema.fields } };
        for (const [name, relation] of Object.entries(this.relations)) {
            schema.fields[name] = relation;
        }
        return schema;
    }
    async refineFilter(caller, filter) {
        return filter?.override({
            conditionTree: await filter.conditionTree?.replaceLeafsAsync(leaf => this.rewriteLeaf(caller, leaf), this),
            // Replace sort in emulated relations to
            // - sorting by the fk of the relation for many to one
            // - removing the sort altogether for one to one
            //
            // This is far from ideal, but the best that can be done without taking a major
            // performance hit.
            // Customers which want proper sorting should enable emulation in the associated
            // middleware
            sort: filter.sort?.replaceClauses(clause => this.rewriteField(clause.field).map(field => ({ ...clause, field }))),
        });
    }
    relationWithOptionalFields(partialJoint) {
        const relation = { ...partialJoint };
        const target = this.dataSource.getCollection(relation.foreignCollection);
        if (relation.type === 'ManyToOne') {
            relation.foreignKeyTarget ?? (relation.foreignKeyTarget = datasource_toolkit_1.SchemaUtils.getPrimaryKeys(target.schema)[0]);
        }
        else if (relation.type === 'OneToOne' || relation.type === 'OneToMany') {
            relation.originKeyTarget ?? (relation.originKeyTarget = datasource_toolkit_1.SchemaUtils.getPrimaryKeys(this.schema)[0]);
        }
        else if (relation.type === 'ManyToMany') {
            relation.originKeyTarget ?? (relation.originKeyTarget = datasource_toolkit_1.SchemaUtils.getPrimaryKeys(this.schema)[0]);
            relation.foreignKeyTarget ?? (relation.foreignKeyTarget = datasource_toolkit_1.SchemaUtils.getPrimaryKeys(target.schema)[0]);
        }
        return relation;
    }
    checkForeignKeys(relation) {
        if (relation.type === 'ManyToOne' || relation.type === 'ManyToMany') {
            RelationCollectionDecorator.checkKeys(relation.type === 'ManyToMany'
                ? this.dataSource.getCollection(relation.throughCollection)
                : this, this.dataSource.getCollection(relation.foreignCollection), relation.foreignKey, relation.foreignKeyTarget);
        }
    }
    checkOriginKeys(relation) {
        if (relation.type === 'OneToMany' ||
            relation.type === 'OneToOne' ||
            relation.type === 'ManyToMany') {
            RelationCollectionDecorator.checkKeys(relation.type === 'ManyToMany'
                ? this.dataSource.getCollection(relation.throughCollection)
                : this.dataSource.getCollection(relation.foreignCollection), this, relation.originKey, relation.originKeyTarget);
        }
    }
    static checkKeys(owner, targetOwner, keyName, targetName) {
        RelationCollectionDecorator.checkColumn(owner, keyName);
        RelationCollectionDecorator.checkColumn(targetOwner, targetName);
        const key = owner.schema.fields[keyName];
        const target = targetOwner.schema.fields[targetName];
        if (key.columnType !== target.columnType) {
            throw new Error(`Types from '${owner.name}.${keyName}' and ` +
                `'${targetOwner.name}.${targetName}' do not match.`);
        }
    }
    static checkColumn(owner, name) {
        const column = owner.schema.fields[name];
        if (!column || column.type !== 'Column') {
            throw new Error(`Column not found: '${owner.name}.${name}'`);
        }
        if (!column.filterOperators?.has('In')) {
            throw new Error(`Column does not support the In operator: '${owner.name}.${name}'`);
        }
    }
    rewriteField(field) {
        const prefix = field.split(':').shift();
        const schema = this.schema.fields[prefix];
        if (schema.type === 'Column')
            return [field];
        const relation = this.dataSource.getCollection(schema.foreignCollection);
        let result = [];
        if (!this.relations[prefix]) {
            result = relation
                .rewriteField(field.substring(prefix.length + 1))
                .map(subField => `${prefix}:${subField}`);
        }
        else if (schema.type === 'ManyToOne') {
            result = [schema.foreignKey];
        }
        else if (schema.type === 'OneToOne' ||
            schema.type === 'OneToMany' ||
            schema.type === 'ManyToMany') {
            result = [schema.originKeyTarget];
        }
        return result;
    }
    async rewriteLeaf(caller, leaf) {
        const prefix = leaf.field.split(':').shift();
        const schema = this.schema.fields[prefix];
        if (schema.type === 'Column')
            return leaf;
        const relation = this.dataSource.getCollection(schema.foreignCollection);
        let result = leaf;
        if (!this.relations[prefix]) {
            result = (await relation.rewriteLeaf(caller, leaf.unnest())).nest(prefix);
        }
        else if (schema.type === 'ManyToOne') {
            const records = await relation.list(caller, new datasource_toolkit_1.Filter({ conditionTree: leaf.unnest() }), new datasource_toolkit_1.Projection(schema.foreignKeyTarget));
            result = new datasource_toolkit_1.ConditionTreeLeaf(schema.foreignKey, 'In', [
                ...new Set(records
                    .map(record => datasource_toolkit_1.RecordUtils.getFieldValue(record, schema.foreignKeyTarget))
                    .filter(v => v !== null)),
            ]);
        }
        else if (schema.type === 'OneToOne') {
            const records = await relation.list(caller, new datasource_toolkit_1.Filter({ conditionTree: leaf.unnest() }), new datasource_toolkit_1.Projection(schema.originKey));
            result = new datasource_toolkit_1.ConditionTreeLeaf(schema.originKeyTarget, 'In', [
                ...new Set(records
                    .map(record => datasource_toolkit_1.RecordUtils.getFieldValue(record, schema.originKey))
                    .filter(v => v !== null)),
            ]);
        }
        return result;
    }
    async reprojectInPlace(caller, records, projection) {
        const promises = Object.entries(projection.relations).map(async ([prefix, subProjection]) => this.reprojectRelationInPlace(caller, records, prefix, subProjection));
        await Promise.all(promises);
    }
    async reprojectRelationInPlace(caller, records, name, projection) {
        const schema = this.schema.fields[name];
        const association = this.dataSource.getCollection(schema.foreignCollection);
        if (!this.relations[name]) {
            await association.reprojectInPlace(caller, records.map(r => r[name]).filter(Boolean), projection);
        }
        else if (schema.type === 'ManyToOne') {
            const ids = records.map(record => record[schema.foreignKey]).filter(fk => fk !== null);
            const subFilter = new datasource_toolkit_1.Filter({
                conditionTree: new datasource_toolkit_1.ConditionTreeLeaf(schema.foreignKeyTarget, 'In', [...new Set(ids)]),
            });
            const subRecords = await association.list(caller, subFilter, projection.union([schema.foreignKeyTarget]));
            for (const record of records) {
                record[name] = subRecords.find(sr => sr[schema.foreignKeyTarget] === record[schema.foreignKey]);
            }
        }
        else if (schema.type === 'OneToOne' || schema.type === 'OneToMany') {
            const ids = records.map(record => record[schema.originKeyTarget]).filter(okt => okt !== null);
            const subFilter = new datasource_toolkit_1.Filter({
                conditionTree: new datasource_toolkit_1.ConditionTreeLeaf(schema.originKey, 'In', [...new Set(ids)]),
            });
            const subRecords = await association.list(caller, subFilter, projection.union([schema.originKey]));
            for (const record of records) {
                record[name] = subRecords.find(sr => sr[schema.originKey] === record[schema.originKeyTarget]);
            }
        }
    }
}
exports.default = RelationCollectionDecorator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sbGVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kZWNvcmF0b3JzL3JlbGF0aW9uL2NvbGxlY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx3RUFrQnlDO0FBSXpDLE1BQXFCLDJCQUE0QixTQUFRLHdDQUFtQjtJQUE1RTs7UUFFWSxjQUFTLEdBQW1DLEVBQUUsQ0FBQztJQWdTM0QsQ0FBQztJQTlSQyxXQUFXLENBQUMsSUFBWSxFQUFFLFlBQWdDO1FBQ3hELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDaEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUUvQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQztRQUNoQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRVEsS0FBSyxDQUFDLElBQUksQ0FDakIsTUFBYyxFQUNkLE1BQXVCLEVBQ3ZCLFVBQXNCO1FBRXRCLE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDMUQsTUFBTSxhQUFhLEdBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoRixNQUFNLE9BQU8sR0FBRyxNQUFNLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDbEYsSUFBSSxhQUFhLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztZQUFFLE9BQU8sT0FBTyxDQUFDO1FBRXJELE1BQU0sSUFBSSxDQUFDLGdCQUFn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